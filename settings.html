<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTV Inventory Hub | Settings</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --sidebar-width: 260px;
            --header-height: 70px;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f1f5f9;
            color: #334155;
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--dark);
            color: white;
            height: 100vh;
            position: fixed;
            overflow-y: auto;
            transition: var(--transition);
            z-index: 1000;
        }
         .sidebar-logo {
            height: 40px;
            width: 40px;
            object-fit: contain;
}
        .sidebar-header {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo {
            height: 40px;
            object-fit: contain;
        }

        .sidebar-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: #cbd5e1;
            text-decoration: none;
            transition: var(--transition);
            gap: 0.75rem;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .menu-item i {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 1.5rem;
        }

        /* Header */
        .header {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .header-title p {
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Card Styles */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .card-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-size: 0.9rem;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--secondary); }
        .btn-outline:hover { background: var(--light); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn.btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }

        /* Table Styles */
        .table-responsive { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 1rem 1.25rem; text-align: left; border-bottom: 1px solid var(--border); }
        .data-table th { background-color: var(--light); font-weight: 600; color: var(--secondary); font-size: 0.9rem; }
        .data-table tbody tr:hover { background-color: #f8fafc; }
        .table-actions { display: flex; gap: 0.5rem; }

        /* Status & District Badges */
        .badge { display: inline-block; padding: 0.35em 0.65em; font-size: 0.75em; font-weight: 600; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: 0.375rem; }
        .badge-success { color: #065f46; background-color: #d1fae5; }
        .badge-warning { color: #92400e; background-color: #fef3c7; }
        .district-badge { background-color: #e0e7ff; color: #3730a3; text-transform: capitalize; }

        /* Alert Messages */
        .alert { padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; }
        .alert-success { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .alert-error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        /* Form Styles */
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark); }
        .form-control { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; transition: var(--transition); }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .password-toggle { position: relative; }
        .password-toggle .form-control { padding-right: 2.5rem; }
        .toggle-password { position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--secondary); cursor: pointer; }

        /* Modal Styles */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background-color: white; border-radius: var(--border-radius); width: 90%; max-width: 600px; box-shadow: var(--shadow); overflow: hidden; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 1.2rem; font-weight: 600; color: var(--dark); }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--secondary); }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; }
        .modal-tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; }
        .modal-tab.active { border-bottom: 2px solid var(--primary); color: var(--primary); font-weight: 500; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .modal-footer { padding: 1.25rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.75rem; }

        /* Table Controls (Search/Filter) */
        .table-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .search-container { position: relative; flex-grow: 1; max-width: 400px; }
        .search-input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--secondary); }
        .filter-group { display: flex; gap: 1rem; align-items: center; }
        .filter-select { padding: 0.65rem; border: 1px solid var(--border); border-radius: 8px; background-color: white; font-size: 0.9rem; }

        /* Settings Tabs */
        .settings-tabs { display: flex; border-bottom: 2px solid var(--border); margin-bottom: 1.5rem; }
        .settings-tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; color: var(--secondary); transition: var(--transition); }
        .settings-tab:hover { color: var(--primary); }
        .settings-tab.active { border-bottom-color: var(--primary); color: var(--primary); }
        .settings-content { display: none; }
        .settings-content.active { display: block; }

    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                 <img src="logo.png" alt="RTV Inventory Hub Logo" class="sidebar-logo">
<h2>RTV Inventory Hub</h2>
            </div>
            <nav class="sidebar-menu">
                <a href="index.html" class="menu-item"><i class="fas fa-home"></i><span>Dashboard</span></a>
                <a href="Inventory.html" class="menu-item"><i class="fas fa-list"></i><span>Inventory</span></a>
                <a href="supervisor.html" class="menu-item"><i class="fas fa-user-shield"></i><span>Supervisor</span></a>
                <a href="transfers.html" class="menu-item"><i class="fas fa-exchange-alt"></i><span>Transfers</span></a>
                <a href="reports.html" class="menu-item"><i class="fas fa-chart-bar"></i><span>Reports</span></a>
                <a href="settings.html" class="menu-item active"><i class="fas fa-cog"></i><span>Settings</span></a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="header-title">
                    <h1>Settings</h1>
                    <p>Manage system settings and user accounts</p>
                </div>
                <div class="user-profile">
                    <div class="avatar">A</div>
                    <div>
                        <div>Dawin</div>
                        <small>Administrator</small>
                    </div>
                </div>
            </header>

            <div class="settings-tabs">
                <div class="settings-tab active" data-tab="supervisors">Supervisor Management</div>
                <div class="settings-tab" data-tab="admin">Admin Profile</div>
                <div class="settings-tab" data-tab="system">System Configuration</div>
            </div>

            <div class="settings-content active" id="supervisorsTab">
                <div class="card">
                    <div class="card-body">
                        <div class="table-controls">
                            <div class="search-container">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="search-input" placeholder="Search by name or email..." id="searchInput">
                            </div>
                            <div class="filter-group">
                                <select class="filter-select" id="statusFilter">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                                <select class="filter-select" id="districtFilter">
                                    <option value="">All Districts</option>
                                </select>
                                <button class="btn btn-primary" id="addSupervisorBtn">
                                    <i class="fas fa-plus"></i> Add Supervisor
                                </button>
                            </div>
                        </div>

                        <div id="supervisorAlert" class="alert"></div>
                        <div class="table-responsive">
                            <table class="data-table" id="supervisorsTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Contact</th>
                                        <th>District</th>
                                        <th>Status</th>
                                        <th>Last Login</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-content" id="adminTab">
                <div class="card">
                    <div class="card-header"><h3>Admin Account Settings</h3></div>
                    <div class="card-body">
                        <div id="adminAlert" class="alert"></div>
                        <form id="adminSettingsForm">
                             <div class="form-group">
                                <label for="adminName">Admin Name</label>
                                <input type="text" class="form-control" id="adminName" value="Dawin" required>
                            </div>
                            <div class="form-group">
                                <label for="adminEmail">Email Address</label>
                                <input type="email" class="form-control" id="adminEmail" value="admin@rtvinventory.com" required>
                            </div>
                            <hr style="border: 0; border-top: 1px solid var(--border); margin: 2rem 0;">
                            <div class="form-group password-toggle">
                                <label for="adminNewPassword">New Password</label>
                                <input type="password" class="form-control" id="adminNewPassword">
                                <button type="button" class="toggle-password" aria-label="Toggle password visibility"><i class="fas fa-eye"></i></button>
                                <small style="color: var(--secondary); margin-top: 5px; display: block;">Leave blank if you don't want to change the password.</small>
                            </div>
                            <div class="form-group password-toggle">
                                <label for="adminConfirmPassword">Confirm New Password</label>
                                <input type="password" class="form-control" id="adminConfirmPassword">
                                <button type="button" class="toggle-password" aria-label="Toggle password visibility"><i class="fas fa-eye"></i></button>
                            </div>
                            <button type="submit" class="btn btn-primary">Update Profile</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="settings-content" id="systemTab">
                 <div class="card">
                    <div class="card-header"><h3>Districts Management</h3></div>
                    <div class="card-body">
                         <div id="districtAlert" class="alert"></div>
                         <form id="addDistrictForm">
                            <div class="form-group">
                                <label for="newDistrictName">Add New District</label>
                                <input type="text" class="form-control" id="newDistrictName" placeholder="e.g., Kampala" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Add District</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal" id="supervisorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add Supervisor</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="supervisorForm">
                    <input type="hidden" id="supervisorId">
                    <div class="form-group">
                        <label for="supervisorName">Full Name *</label>
                        <input type="text" class="form-control" id="supervisorName" required>
                    </div>
                    <div class="form-group">
                        <label for="supervisorEmail">Email Address *</label>
                        <input type="email" class="form-control" id="supervisorEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="supervisorDistrict">District *</label>
                        <select class="form-control" id="supervisorDistrict" required>
                            <option value="">Select District</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="supervisorStatus">Status *</label>
                        <select class="form-control" id="supervisorStatus" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group password-toggle" id="password-group">
                        <label for="supervisorPassword">Password *</label>
                        <input type="password" class="form-control" id="supervisorPassword" required>
                        <button type="button" class="toggle-password"><i class="fas fa-eye"></i></button>
                        <small style="color: var(--secondary); margin-top: 5px; display: block;">Required for new supervisors. Must be at least 8 characters.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelSupervisor">Cancel</button>
                <button class="btn btn-primary" id="saveSupervisor">Save Supervisor</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="deleteModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header"><h3>Confirm Deletion</h3><button class="modal-close">&times;</button></div>
            <div class="modal-body">
                <p>Are you sure you want to delete this supervisor? This action cannot be undone.</p>
                <p><strong id="deleteSupervisorName"></strong></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelDelete">Cancel</button>
                <button class="btn btn-danger" id="confirmDelete">Delete Supervisor</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="changePasswordModal">
         <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header"><h3>Change Password for <span id="passwordSupervisorName"></span></h3><button class="modal-close">&times;</button></div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <input type="hidden" id="passwordSupervisorId">
                    <div class="form-group password-toggle">
                        <label for="newSupervisorPassword">New Password *</label>
                        <input type="password" class="form-control" id="newSupervisorPassword" required>
                        <button type="button" class="toggle-password"><i class="fas fa-eye"></i></button>
                    </div>
                    <div class="form-group password-toggle">
                        <label for="confirmNewPassword">Confirm New Password *</label>
                        <input type="password" class="form-control" id="confirmNewPassword" required>
                        <button type="button" class="toggle-password"><i class="fas fa-eye"></i></button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelPasswordChange">Cancel</button>
                <button class="btn btn-primary" id="savePasswordChange">Update Password</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Keys for localStorage
            const SUPERVISORS_KEY = 'supervisors';
            const DISTRICTS_KEY = 'districts';

            // --- Initial Setup ---
            function initializeApp() {
                initializeDistricts();
                initializeSupervisors();
                
                populateDistrictDropdowns();
                loadSupervisors();
                
                setupEventListeners();
            }

            function initializeDistricts() {
                // V V V THIS IS THE UPDATED ARRAY V V V
                const defaultDistricts = [
                    "Kisoro", "Kanungu", "Rukungiri", "Kagadi", "Mitooma", "Kyenjojo", 
                    "Kaliro", "Rubanda", "Luuka", "Kiryandongo", "Kibaale", "Rubirizi", "Rukiga", 
                    "Buwehju", "Kitagwenda", "Kakumiro", "Sironko", "Kapchorwa", "Nwoya", "Amuru", 
                    "Gulu", "Kyegegwa", "Isingiro", "Kassanda", "Bugiri", "Bunyangabu"
                ];
                // ^ ^ ^ THIS IS THE UPDATED ARRAY ^ ^ ^

                if (!localStorage.getItem(DISTRICTS_KEY)) {
                    localStorage.setItem(DISTRICTS_KEY, JSON.stringify(defaultDistricts));
                }
            }

            function initializeSupervisors() {
                if (!localStorage.getItem(SUPERVISORS_KEY)) {
                    const sampleSupervisors = [
                        { id: 1, name: 'John Smith', email: 'john.smith@example.com', district: 'Kagadi', status: 'active', lastLogin: 'Today, 09:24 AM', password: 'password123'},
                        { id: 2, name: 'Sarah Johnson', email: 'sarah.j@example.com', district: 'Kibaale', status: 'active', lastLogin: 'Yesterday, 03:45 PM', password: 'password123'},
                        { id: 3, name: 'Mike Davis', email: 'mike.davis@example.com', district: 'Kyenjojo', status: 'inactive', lastLogin: '3 days ago', password: 'password123'}
                    ];
                    localStorage.setItem(SUPERVISORS_KEY, JSON.stringify(sampleSupervisors));
                }
            }
            
            // --- Data Functions ---
            const getData = key => JSON.parse(localStorage.getItem(key)) || [];
            const saveData = (key, data) => {
                localStorage.setItem(key, JSON.stringify(data));
                window.dispatchEvent(new Event('storage')); // Notify other tabs
            };

            // --- UI Rendering ---
            function loadSupervisors() {
                const supervisors = getData(SUPERVISORS_KEY);
                const tableBody = document.querySelector('#supervisorsTable tbody');
                tableBody.innerHTML = '';
                
                if (supervisors.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No supervisors found</td></tr>';
                    return;
                }
                
                supervisors.forEach(s => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div>${s.name}</div>
                            <small style="color:var(--secondary);">${s.email}</small>
                        </td>
                        <td>${s.phone || 'N/A'}</td>
                        <td><span class="badge district-badge">${s.district}</span></td>
                        <td><span class="badge ${s.status === 'active' ? 'badge-success' : 'badge-warning'}">${s.status}</span></td>
                        <td>${s.lastLogin || 'Never'}</td>
                        <td class="table-actions">
                            <button class="btn btn-sm btn-outline edit-btn" data-id="${s.id}"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn btn-sm btn-outline password-btn" data-id="${s.id}" data-name="${s.name}"><i class="fas fa-key"></i> Pass</button>
                            <button class="btn btn-sm btn-danger delete-btn" data-id="${s.id}" data-name="${s.name}"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            
            function populateDistrictDropdowns() {
                const districts = getData(DISTRICTS_KEY).sort();
                const filterDropdown = document.getElementById('districtFilter');
                const modalDropdown = document.getElementById('supervisorDistrict');
                
                // Clear existing options except the first one
                filterDropdown.innerHTML = '<option value="">All Districts</option>';
                modalDropdown.innerHTML = '<option value="">Select District</option>';
                
                districts.forEach(d => {
                    const optionHTML = `<option value="${d}">${d}</option>`;
                    filterDropdown.insertAdjacentHTML('beforeend', optionHTML);
                    modalDropdown.insertAdjacentHTML('beforeend', optionHTML);
                });
            }

            // --- Event Listeners Setup ---
            function setupEventListeners() {
                // Main settings tabs
                document.querySelectorAll('.settings-tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        document.querySelectorAll('.settings-tab, .settings-content').forEach(el => el.classList.remove('active'));
                        this.classList.add('active');
                        document.getElementById(this.dataset.tab + 'Tab').classList.add('active');
                    });
                });

                // Supervisor table actions
                document.querySelector('#supervisorsTable').addEventListener('click', e => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    
                    const id = button.dataset.id;
                    const name = button.dataset.name;
                    if (button.classList.contains('edit-btn')) openModal('supervisorModal', { id });
                    if (button.classList.contains('password-btn')) openModal('changePasswordModal', { id, name });
                    if (button.classList.contains('delete-btn')) openModal('deleteModal', { id, name });
                });

                // Add Supervisor Button
                document.getElementById('addSupervisorBtn').addEventListener('click', () => openModal('supervisorModal'));

                // Modals general close buttons
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', e => {
                        if (e.target === modal || e.target.closest('.modal-close, .btn-outline[id^="cancel"]')) {
                            closeModal(modal.id);
                        }
                    });
                });

                // Save/Confirm buttons in modals
                document.getElementById('saveSupervisor').addEventListener('click', handleSaveSupervisor);
                document.getElementById('confirmDelete').addEventListener('click', handleDeleteSupervisor);
                document.getElementById('savePasswordChange').addEventListener('click', handlePasswordChange);
                
                // Add new district form
                document.getElementById('addDistrictForm').addEventListener('submit', handleAddDistrict);

                // Filters
                document.getElementById('searchInput').addEventListener('input', filterTable);
                document.getElementById('statusFilter').addEventListener('change', filterTable);
                document.getElementById('districtFilter').addEventListener('change', filterTable);
                
                // Password visibility toggles
                document.querySelectorAll('.toggle-password').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const input = btn.previousElementSibling;
                        const icon = btn.querySelector('i');
                        input.type = input.type === 'password' ? 'text' : 'password';
                        icon.classList.toggle('fa-eye');
                        icon.classList.toggle('fa-eye-slash');
                    });
                });
                
                // Real-time updates from other tabs
                window.addEventListener('storage', () => {
                    loadSupervisors();
                    populateDistrictDropdowns();
                });
            }

            // --- Modal Management ---
            function openModal(modalId, data = {}) {
                const modal = document.getElementById(modalId);
                
                if (modalId === 'supervisorModal') {
                    const form = document.getElementById('supervisorForm');
                    form.reset();
                    if (data.id) { // Editing
                        const supervisors = getData(SUPERVISORS_KEY);
                        const supervisor = supervisors.find(s => s.id == data.id);
                        document.getElementById('modalTitle').textContent = 'Edit Supervisor';
                        document.getElementById('supervisorId').value = supervisor.id;
                        document.getElementById('supervisorName').value = supervisor.name;
                        document.getElementById('supervisorEmail').value = supervisor.email;
                        document.getElementById('supervisorDistrict').value = supervisor.district;
                        document.getElementById('supervisorStatus').value = supervisor.status;
                        document.getElementById('password-group').style.display = 'none';
                        document.getElementById('supervisorPassword').required = false;
                    } else { // Adding
                        document.getElementById('modalTitle').textContent = 'Add Supervisor';
                        document.getElementById('supervisorId').value = '';
                        document.getElementById('password-group').style.display = 'block';
                        document.getElementById('supervisorPassword').required = true;
                    }
                } else if (modalId === 'changePasswordModal') {
                    document.getElementById('passwordSupervisorName').textContent = data.name;
                    document.getElementById('passwordSupervisorId').value = data.id;
                    document.getElementById('changePasswordForm').reset();
                } else if (modalId === 'deleteModal') {
                    document.getElementById('deleteSupervisorName').textContent = data.name;
                    document.getElementById('confirmDelete').dataset.id = data.id;
                }
                
                modal.style.display = 'flex';
            }
            
            function closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            // --- Action Handlers ---
            function handleSaveSupervisor() {
                const id = document.getElementById('supervisorId').value;
                const name = document.getElementById('supervisorName').value.trim();
                const email = document.getElementById('supervisorEmail').value.trim();
                const district = document.getElementById('supervisorDistrict').value;
                const status = document.getElementById('supervisorStatus').value;
                const password = document.getElementById('supervisorPassword').value;

                if (!name || !email || !district) return showAlert('supervisorAlert', 'error', 'Please fill all required fields.');
                if (!id && (!password || password.length < 8)) return showAlert('supervisorAlert', 'error', 'New supervisors require a password of at least 8 characters.');

                let supervisors = getData(SUPERVISORS_KEY);
                if (id) { // Update existing
                    const index = supervisors.findIndex(s => s.id == id);
                    if (index > -1) supervisors[index] = { ...supervisors[index], name, email, district, status };
                } else { // Add new
                    const newId = supervisors.length > 0 ? Math.max(...supervisors.map(s => s.id)) + 1 : 1;
                    supervisors.unshift({ id: newId, name, email, district, status, password, lastLogin: 'Never' });
                }
                saveData(SUPERVISORS_KEY, supervisors);
                loadSupervisors();
                closeModal('supervisorModal');
                showAlert('supervisorAlert', 'success', `Supervisor ${name} saved successfully!`);
            }
            
            function handleDeleteSupervisor() {
                const id = document.getElementById('confirmDelete').dataset.id;
                let supervisors = getData(SUPERVISORS_KEY);
                supervisors = supervisors.filter(s => s.id != id);
                saveData(SUPERVISORS_KEY, supervisors);
                loadSupervisors();
                closeModal('deleteModal');
                showAlert('supervisorAlert', 'success', 'Supervisor deleted successfully.');
            }
            
            function handlePasswordChange(e) {
                e.preventDefault();
                const id = document.getElementById('passwordSupervisorId').value;
                const newPass = document.getElementById('newSupervisorPassword').value;
                const confirmPass = document.getElementById('confirmNewPassword').value;
                
                if (newPass.length < 8) return alert('Password must be at least 8 characters.');
                if (newPass !== confirmPass) return alert('Passwords do not match.');

                let supervisors = getData(SUPERVISORS_KEY);
                const index = supervisors.findIndex(s => s.id == id);
                if (index > -1) {
                    supervisors[index].password = newPass;
                    saveData(SUPERVISORS_KEY, supervisors);
                    closeModal('changePasswordModal');
                    showAlert('supervisorAlert', 'success', 'Password updated successfully.');
                }
            }
            
            function handleAddDistrict(e) {
                e.preventDefault();
                const districtInput = document.getElementById('newDistrictName');
                const newDistrict = districtInput.value.trim();
                if (!newDistrict) return;

                let districts = getData(DISTRICTS_KEY);
                if (districts.map(d => d.toLowerCase()).includes(newDistrict.toLowerCase())) {
                    showAlert('districtAlert', 'error', `District "${newDistrict}" already exists.`);
                    return;
                }
                districts.push(newDistrict);
                saveData(DISTRICTS_KEY, districts);
                populateDistrictDropdowns();
                districtInput.value = '';
                showAlert('districtAlert', 'success', `District "${newDistrict}" added successfully.`);
            }

            // --- Utilities ---
            function filterTable() {
                const searchText = document.getElementById('searchInput').value.toLowerCase();
                const statusValue = document.getElementById('statusFilter').value;
                const districtValue = document.getElementById('districtFilter').value;
                
                document.querySelectorAll('#supervisorsTable tbody tr').forEach(row => {
                    const nameEmail = row.cells[0].textContent.toLowerCase();
                    const district = row.cells[2].textContent.toLowerCase();
                    const status = row.cells[3].textContent.toLowerCase();
                    
                    const matchesSearch = nameEmail.includes(searchText);
                    const matchesStatus = statusValue === '' || status.includes(statusValue);
                    const matchesDistrict = districtValue === '' || district.includes(districtValue.toLowerCase());
                    
                    row.style.display = (matchesSearch && matchesStatus && matchesDistrict) ? '' : 'none';
                });
            }

            function showAlert(alertId, type, message) {
                const alertEl = document.getElementById(alertId);
                alertEl.className = `alert alert-${type}`;
                alertEl.textContent = message;
                alertEl.style.display = 'block';
                setTimeout(() => alertEl.style.display = 'none', 4000);
            }

            // --- Run Application ---
            initializeApp();
        });
    </script>
</body>
</html>